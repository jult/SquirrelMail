<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    publications:sa-wrapper    [GTMP Foundation]
  </title>

  <meta name="generator" content="DokuWiki Release 2007-06-26b" />
<meta name="robots" content="index,follow" />
<meta name="date" content="2007-09-18T18:36:57+0200" />
<meta name="keywords" content="publications,sa-wrapper" />
<link rel="search" type="application/opensearchdescription+xml" href="/lib/exe/opensearch.php" title="GTMP Foundation" />
<link rel="start" href="/" />
<link rel="contents" href="/doku.php/publications/sa-wrapper?do=index" title="Index" />

<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="/feed.php" />
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="/feed.php?mode=list&amp;ns=publications" />
<link rel="alternate" type="text/html" title="Plain HTML" href="/doku.php/publications/sa-wrapper?do=export_xhtml" />
<link rel="alternate" type="text/plain" title="Wiki Markup" href="/doku.php/publications/sa-wrapper?do=export_raw" />
<link rel="stylesheet" media="all" type="text/css" href="/lib/exe/css.php?s=all" />
<link rel="stylesheet" media="screen" type="text/css" href="/lib/exe/css.php" />
<link rel="stylesheet" media="print" type="text/css" href="/lib/exe/css.php?s=print" />
<script type="text/javascript" charset="utf-8" src="/lib/exe/js.php?edit=0&amp;write=0" ></script>

  <link rel="shortcut icon" href="/lib/tpl/default/images/favicon.ico" />

  </head>

<body>

<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="/doku.php/publications/sa-wrapper?do=backlink" >publications:sa-wrapper</a>]]
      </div>
      <div class="logo">
        <a href="/doku.php/"  name="dokuwiki__top" id="dokuwiki__top" accesskey="h" title="[ALT+H]">GTMP Foundation</a>      </div>

      <div class="clearer"></div>
    </div>

    
    <div class="bar" id="bar__top">
      <div class="bar-left" id="bar__topleft">
        <form class="button" method="post" action="/doku.php/publications/sa-wrapper"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="submit" value="Show pagesource" class="button" accesskey="v" title="Show pagesource [ALT+V]" /></div></form>        <form class="button" method="get" action="/doku.php/publications/sa-wrapper"><div class="no"><input type="hidden" name="do" value="revisions" /><input type="submit" value="Old revisions" class="button" accesskey="o" title="Old revisions [ALT+O]" /></div></form>      </div>

      <div class="bar-right" id="bar__topright">

        <form class="button" method="get" action="/doku.php/"><div class="no"><input type="hidden" name="do" value="recent" /><input type="submit" value="Recent changes" class="button" accesskey="r" title="Recent changes [ALT+R]" /></div></form>        <form action="/doku.php/" accept-charset="utf-8" class="search" id="dw__search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch__in" accesskey="f" name="id" class="edit" title="[ALT+F]" /><input type="submit" value="Search" class="button" title="Search" /><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>&nbsp;
      </div>

      <div class="clearer"></div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="/doku.php/publications/sa-postfix-en"  class="breadcrumbs" title="publications:sa-postfix-en">sa-postfix-en</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="/doku.php/publications/sa-wrapper"  class="breadcrumbs" title="publications:sa-wrapper">sa-wrapper</a></span>          </div>

    
        <div class="breadcrumbs">
      You are here: <a href="/doku.php/start"  title="start">start</a> &raquo; <a href="/doku.php/publications"  title="publications">publications</a> &raquo; <a href="/doku.php/publications/sa-wrapper"  title="publications:sa-wrapper">sa-wrapper</a>    </div>
    
  </div>
  
  
  <div class="page">

    <!-- wikipage start -->
    


<h1><a name="sa-wrapper.pl" id="sa-wrapper.pl">sa-wrapper.pl</a></h1>
<div class="level1">
<pre class="code perl"><span class="co1">#!/usr/bin/perl -w</span>
<span class="co1"># Time-stamp: &lt;05 April 2004, 13:37 home&gt;</span>
<span class="co1">#</span>
<span class="co1"># sa-wrapper.pl</span>
<span class="co1">#</span>

<span class="co1"># SpamAssassin sa-learn wrapper</span>
<span class="co1"># (c) Alexandre Jousset, 2004</span>
<span class="co1"># This script is GPL'd</span>
<span class="co1">#</span>
<span class="co1"># Thanks to: Chung-Kie Tung for the removal of the dir</span>
<span class="co1">#            Adam Gent for bug report</span>
<span class="co1">#</span>
<span class="co1"># v1.2</span>
&nbsp;

<span class="kw2">use</span> strict;
<span class="kw2">use</span> MIME::<span class="me2">Tools</span>;
<span class="kw2">use</span> MIME::<span class="me2">Parser</span>;
&nbsp;
<span class="kw1">my</span> <span class="re0">$DEBUG</span> = <span class="nu0">0</span>;

<span class="kw1">my</span> <span class="re0">$UNPACK_DIR</span> = <span class="st0">'/var/spool/amavis/mime'</span>;
<span class="kw1">my</span> <span class="re0">$SA_LEARN</span> = <span class="st0">'/usr/bin/sa-learn'</span>;
<span class="kw1">my</span> <span class="re0">@DOMAINS</span> = <a href="http://www.perldoc.com/perl5.6/pod/func/qw.html"><span class="kw3">qw</span></a>/example.com example.org/;

&nbsp;
<span class="kw1">my</span> <span class="br0">&#40;</span><span class="re0">$spamham</span>, <span class="re0">$sender</span><span class="br0">&#41;</span> = <span class="re0">@ARGV</span>;
&nbsp;
<span class="kw2">sub</span> recurs
<span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$ent</span> = <a href="http://www.perldoc.com/perl5.6/pod/func/shift.html"><span class="kw3">shift</span></a>;

&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ent</span>-&gt;<span class="me1">head</span>-&gt;<span class="me1">mime_type</span> eq <span class="st0">'message/rfc822'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$DEBUG</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>

            <a href="http://www.perldoc.com/perl5.6/pod/func/unlink.html"><span class="kw3">unlink</span></a> <span class="st0">&quot;/tmp/spam.log.$$&quot;</span> <span class="kw1">if</span> -e <span class="st0">&quot;/tmp/spam.log.$$&quot;</span>;
            <a href="http://www.perldoc.com/perl5.6/pod/func/open.html"><span class="kw3">open</span></a><span class="br0">&#40;</span>OUT, <span class="st0">&quot;|$SA_LEARN -D --$spamham --single &gt;&gt;/tmp/spam.log.$$ 2&gt;&amp;1&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <a href="http://www.perldoc.com/perl5.6/pod/func/die.html"><span class="kw3">die</span></a> <span class="st0">&quot;Cannot pipe $SA_LEARN: $!&quot;</span>;
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>

            <a href="http://www.perldoc.com/perl5.6/pod/func/open.html"><span class="kw3">open</span></a><span class="br0">&#40;</span>OUT, <span class="st0">&quot;|$SA_LEARN --$spamham --single&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <a href="http://www.perldoc.com/perl5.6/pod/func/die.html"><span class="kw3">die</span></a> <span class="st0">&quot;Cannot pipe $SA_LEARN: $!&quot;</span>;
        <span class="br0">&#125;</span>
&nbsp;
        <span class="re0">$ent</span>-&gt;<span class="me1">bodyhandle</span>-&gt;<span class="me1">print</span><span class="br0">&#40;</span>\*OUT<span class="br0">&#41;</span>;

&nbsp;
        <a href="http://www.perldoc.com/perl5.6/pod/func/close.html"><span class="kw3">close</span></a><span class="br0">&#40;</span>OUT<span class="br0">&#41;</span>;
        <a href="http://www.perldoc.com/perl5.6/pod/func/return.html"><span class="kw3">return</span></a>;
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">my</span> <span class="re0">@parts</span> = <span class="re0">$ent</span>-&gt;<span class="me1">parts</span>;

&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">@parts</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <a href="http://www.perldoc.com/perl5.6/pod/func/map.html"><span class="kw3">map</span></a> <span class="br0">&#123;</span> recurs<span class="br0">&#40;</span><span class="re0">$_</span><span class="br0">&#41;</span> <span class="br0">&#125;</span> <span class="re0">@parts</span>;
    <span class="br0">&#125;</span>

<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">my</span> <span class="br0">&#40;</span><span class="re0">$domain</span><span class="br0">&#41;</span> = <span class="re0">$sender</span> =~ /\@<span class="br0">&#40;</span>.*<span class="br0">&#41;</span>$/;
<span class="kw1">unless</span> <span class="br0">&#40;</span><a href="http://www.perldoc.com/perl5.6/pod/func/grep.html"><span class="kw3">grep</span></a> <span class="br0">&#123;</span> <span class="re0">$_</span> eq <span class="re0">$domain</span> <span class="br0">&#125;</span> <span class="re0">@DOMAINS</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>

    <a href="http://www.perldoc.com/perl5.6/pod/func/die.html"><span class="kw3">die</span></a> <span class="st0">&quot;I don't recognize your domain !&quot;</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$DEBUG</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    MIME::<span class="me2">Tools</span>-&gt;<span class="me1">debugging</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>;
    <a href="http://www.perldoc.com/perl5.6/pod/func/open.html"><span class="kw3">open</span></a><span class="br0">&#40;</span><span class="kw2">STDERR</span>, <span class="st0">&quot;&gt;/tmp/spam_err.log&quot;</span><span class="br0">&#41;</span>;

<span class="br0">&#125;</span>
<span class="kw1">my</span> <span class="re0">$parser</span> = <span class="kw2">new</span> MIME::<span class="me2">Parser</span>;
<span class="re0">$parser</span>-&gt;<span class="me1">extract_nested_messages</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span>;
<span class="re0">$parser</span>-&gt;<span class="me1">output_under</span><span class="br0">&#40;</span><span class="re0">$UNPACK_DIR</span><span class="br0">&#41;</span>;

&nbsp;
<span class="kw1">my</span> <span class="re0">$entity</span>;
<a href="http://www.perldoc.com/perl5.6/pod/func/eval.html"><span class="kw3">eval</span></a> <span class="br0">&#123;</span>
    <span class="re0">$entity</span> = <span class="re0">$parser</span>-&gt;<span class="me1">parse</span><span class="br0">&#40;</span>\*<span class="kw2">STDIN</span><span class="br0">&#41;</span>;

<span class="br0">&#125;</span>;
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span>$@<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <a href="http://www.perldoc.com/perl5.6/pod/func/die.html"><span class="kw3">die</span></a> $@;
<span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
    recurs<span class="br0">&#40;</span><span class="re0">$entity</span><span class="br0">&#41;</span>;

<span class="br0">&#125;</span>
&nbsp;
<span class="re0">$parser</span>-&gt;<span class="me1">filer</span>-&gt;<span class="me1">purge</span>;
<a href="http://www.perldoc.com/perl5.6/pod/func/rmdir.html"><span class="kw3">rmdir</span></a> <span class="re0">$parser</span>-&gt;<span class="me1">output_dir</span>;</pre>
</div>

    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>

      <div class="doc">
        publications/sa-wrapper.txt &middot; Last modified: 18/09/2007 18:36 by mid      </div>
    </div>

   
    <div class="bar" id="bar__bottom">
      <div class="bar-left" id="bar__bottomleft">
        <form class="button" method="post" action="/doku.php/publications/sa-wrapper"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="submit" value="Show pagesource" class="button" accesskey="v" title="Show pagesource [ALT+V]" /></div></form>        <form class="button" method="get" action="/doku.php/publications/sa-wrapper"><div class="no"><input type="hidden" name="do" value="revisions" /><input type="submit" value="Old revisions" class="button" accesskey="o" title="Old revisions [ALT+O]" /></div></form>      </div>

      <div class="bar-right" id="bar__bottomright">
                                <form class="button" method="get" action="/doku.php/publications/sa-wrapper"><div class="no"><input type="hidden" name="do" value="login" /><input type="submit" value="Login" class="button" title="Login" /></div></form>        <form class="button" method="get" action="/doku.php/publications/sa-wrapper"><div class="no"><input type="hidden" name="do" value="index" /><input type="submit" value="Index" class="button" accesskey="x" title="Index [ALT+X]" /></div></form>        <a class="nolink" href="#dokuwiki__top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" title="Back to top" /></a>&nbsp;
      </div>
      <div class="clearer"></div>
    </div>

  </div>

</div>

<div class="footerinc">
  <a  href="/feed.php" title="Recent changes RSS feed"><img src="/lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" /></a>

  <a  href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="/lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" /></a>

  <a  href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="/lib/tpl/default/images/button-donate.gif" alt="Donate" width="80" height="15" /></a>

  <a  href="http://www.php.net" title="Powered by PHP"><img src="/lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>

  <a  href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="/lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" /></a>

  <a  href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS"><img src="/lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>

  <a  href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="/lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->


</div>

<div class="no"><img src="/lib/exe/indexer.php?id=publications%3Asa-wrapper&amp;1191008389" width="1" height="1" alt=""  /></div>
</body>
</html>

